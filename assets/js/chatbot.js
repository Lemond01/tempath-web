class ChatBot {
    constructor() {
        this.isOpen = false;
        this.messages = [];
        this.userInactivityTimeout = null;
        this.userInactivityFinalTimeout = null;
    this.status = 'dormido'; // 'dormido' or 'disponible'
        this.init();
    }

    init() {
        this.bindEvents();
        this.setupAutoResize();
    this.setStatus('dormido');
    }
    setStatus(status) {
        // status: 'dormido' | 'disponible'
        const statusEl = document.getElementById('chatbotStatus');
        if (!statusEl) return;
        const dot = statusEl.querySelector('.chatbot-status-dot');
        const text = statusEl.querySelector('.chatbot-status-text');
        if (status === 'disponible') {
            dot.style.background = '#00C853';
            text.textContent = 'Disponible';
        } else {
            dot.style.background = '#FFD600';
            text.textContent = 'Dormido';
        }
        this.status = status;
    }

    bindEvents() {
        const toggleBtn = document.getElementById('chatbotToggle');
        const closeBtn = document.getElementById('chatbotClose');
        const sendBtn = document.getElementById('chatbotSend');
        const input = document.getElementById('chatbotInput');
        const quickOptions = document.querySelectorAll('.chatbot-quick-option');

        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => this.toggleChat());
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.closeChat());
        }

        if (sendBtn) {
            sendBtn.addEventListener('click', () => this.sendMessage());
        }

        if (input) {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
        }

        // Opciones r√°pidas
        quickOptions.forEach(option => {
            option.addEventListener('click', () => {
                const message = option.getAttribute('data-message');
                this.sendUserMessage(message);
                option.style.display = 'none';
            });
        });

        // Cerrar al hacer clic fuera
        document.addEventListener('click', (e) => {
            const widget = document.querySelector('.chatbot-widget');
            if (widget && !widget.contains(e.target) && this.isOpen) {
                this.closeChat();
            }
        });
    }

    setupAutoResize() {
        const input = document.getElementById('chatbotInput');
        if (input) {
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            });
        }
    }

    toggleChat() {
        if (this.isOpen) {
            this.closeChat();
        } else {
            this.openChat();
        }
    }

    openChat() {
        const window = document.getElementById('chatbotWindow');
        if (window) {
            window.classList.add('active');
            this.isOpen = true;
            
            // Focus en el input
            setTimeout(() => {
                const input = document.getElementById('chatbotInput');
                if (input) input.focus();
            }, 300);
        }
    }

    closeChat() {
        const window = document.getElementById('chatbotWindow');
        if (window) {
            window.classList.remove('active');
            this.isOpen = false;
        }
    }

    sendMessage() {
        const input = document.getElementById('chatbotInput');
        if (!input) return;

        const message = input.value.trim();
        if (!message) return;

        this.sendUserMessage(message);
        input.value = '';
        input.style.height = 'auto';
    }

    sendUserMessage(message) {

        // Cambiar a disponible si es el primer mensaje del usuario
        if (this.status !== 'disponible') {
            this.setStatus('disponible');
        }
        this.addMessage(message, 'user');
        this.showTyping();

        // Limpiar timeouts de inactividad
        if (this.userInactivityTimeout) clearTimeout(this.userInactivityTimeout);
        if (this.userInactivityFinalTimeout) clearTimeout(this.userInactivityFinalTimeout);

        // Soporte: detectar si el √∫ltimo mensaje del bot fue la pregunta de opciones o atenci√≥n personalizada
        const lastBotMsg = this.messages.slice().reverse().find(m => m.sender === 'bot');
        const trimmed = message.trim();
        if (lastBotMsg && lastBotMsg.content) {
            // Opciones de soporte general
            if (lastBotMsg.content.includes('¬øQu√© quieres hacer?')) {
                if (trimmed === '1') {
                    setTimeout(() => {
                        this.hideTyping();
                        window.open('https://accounts.google.com/servicelogin?service=mail', '_blank');
                        this.addMessage('Abriendo Gmail para que puedas escribirnos a <b>soporte@tempath.com</b>...', 'bot');
                    }, 800);
                    return;
                } else if (trimmed === '2') {
                    setTimeout(() => {
                        this.hideTyping();
                        document.getElementById('chatbotClose')?.click();
                        const contactSection = document.getElementById('contact') || document.querySelector('[id*="contact"]');
                        if (contactSection && typeof contactSection.scrollIntoView === 'function') {
                            contactSection.scrollIntoView({ behavior: 'smooth' });
                        } else {
                            window.location.hash = '#contact';
                        }
                        this.addMessage('Te llevamos al formulario de contacto. ¬°D√©janos tu mensaje!', 'bot');
                    }, 800);
                    return;
                } else if (trimmed === '3') {
                    setTimeout(() => {
                        this.hideTyping();
                        window.open('https://web.whatsapp.com/', '_blank');
                        this.addMessage('Abriendo WhatsApp Web. Pronto tendr√°s soporte directo por WhatsApp.', 'bot');
                    }, 800);
                    return;
                }
            }
            // Opciones de atenci√≥n personalizada
            if (lastBotMsg.content.includes('Si necesitas atenci√≥n personalizada, aqu√≠ tienes opciones:')) {
                if (trimmed === '1') {
                    setTimeout(() => {
                        this.hideTyping();
                        window.open('https://accounts.google.com/servicelogin?service=mail', '_blank');
                        this.addMessage('Abriendo Gmail para que puedas escribirnos a <b>soporte@tempath.com</b>...', 'bot');
                    }, 800);
                    return;
                } else if (trimmed === '2') {
                    setTimeout(() => {
                        this.hideTyping();
                        document.getElementById('chatbotClose')?.click();
                        const contactSection = document.getElementById('contact') || document.querySelector('[id*="contact"]');
                        if (contactSection && typeof contactSection.scrollIntoView === 'function') {
                            contactSection.scrollIntoView({ behavior: 'smooth' });
                        } else {
                            window.location.hash = '#contact';
                        }
                        this.addMessage('Te llevamos al formulario de contacto. ¬°D√©janos tu mensaje!', 'bot');
                    }, 800);
                    return;
                } else if (trimmed === '3') {
                    setTimeout(() => {
                        this.hideTyping();
                        window.open('https://web.whatsapp.com/', '_blank');
                        this.addMessage('Abriendo WhatsApp Web. Pronto tendr√°s soporte directo por WhatsApp.', 'bot');
                    }, 800);
                    return;
                }
            }
        }

        // Simular respuesta del bot normal
        setTimeout(() => {
            this.hideTyping();
            const response = this.generateResponse(message);
            this.addMessage(response, 'bot');
            this.startUserInactivityTimers();
        }, 1000 + Math.random() * 1000);
    }

    startUserInactivityTimers() {
        // Primer recordatorio a los X segundos
        this.userInactivityTimeout = setTimeout(() => {
            this.addMessage('‚è≥ <i>¬øSigues ah√≠? Si necesitas m√°s ayuda, ¬°aqu√≠ estoy!</i>', 'bot');
        }, 30000);
        // Despedida a los X segundos
        this.userInactivityFinalTimeout = setTimeout(() => {
            this.addMessage('üëã <b>Gracias por tu visita. Si necesitas m√°s ayuda, vuelve cuando quieras. ¬°√âxito con tu p√°gina Tempath!</b>', 'bot');
            this.setStatus('dormido');
        }, 50000);
    }

    addMessage(content, sender) {
        const messagesContainer = document.getElementById('chatbotMessages');
        if (!messagesContainer) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `chatbot-message ${sender}`;
        
    const contentDiv = document.createElement('div');
    contentDiv.className = 'chatbot-message-content';
    contentDiv.innerHTML = content;
        
        messageDiv.appendChild(contentDiv);
        
        // Insertar antes del indicador de escritura
        const typingIndicator = document.getElementById('chatbotTyping');
        messagesContainer.insertBefore(messageDiv, typingIndicator);
        
        // Scroll al final
        this.scrollToBottom();
        
        // Guardar mensaje
        this.messages.push({ content, sender, timestamp: new Date() });

        // Si es un mensaje de despedida del bot, volver a dormido
        if (sender === 'bot' && typeof content === 'string') {
            if (content.includes('Gracias por tu visita') || content.includes('¬°√âxito con tu p√°gina Tempath!')) {
                this.setStatus('dormido');
            }
        }
    }

    showTyping() {
        const typing = document.getElementById('chatbotTyping');
        if (typing) {
            typing.style.display = 'flex';
            this.scrollToBottom();
        }
    }

    hideTyping() {
        const typing = document.getElementById('chatbotTyping');
        if (typing) {
            typing.style.display = 'none';
        }
    }

    scrollToBottom() {
        const messagesContainer = document.getElementById('chatbotMessages');
        if (messagesContainer) {
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
    }

    generateResponse(message) {
        const lowerMessage = message.toLowerCase();

        // Horarios
        if (lowerMessage.includes('horario') || lowerMessage.includes('horarios') || lowerMessage.includes('a qu√© hora') || lowerMessage.includes('a que hora') || lowerMessage.includes('cu√°ndo abren') || lowerMessage.includes('cuando abren')) {
            return '‚è∞ <b>Nuestro horario de atenci√≥n:</b><br>' +
                '<ul style="margin: 8px 0 8px 18px; padding: 0;">' +
                '<li>Lunes a viernes: <b>9:00 AM a 6:00 PM</b></li>' +
                '</ul>' +
                '¬°Puedes contactarnos en cualquier momento y te responderemos lo antes posible!';
        }

        // Ubicaci√≥n
        if (lowerMessage.includes('ubicaci√≥n') || lowerMessage.includes('ubicacion') || lowerMessage.includes('d√≥nde est√°n') || lowerMessage.includes('donde estan') || lowerMessage.includes('d√≥nde se encuentran') || lowerMessage.includes('donde se encuentran')) {
            return 'üìç <b>Nuestra oficina principal est√° en M√©xico</b>,<br>pero <b>Tempath es una plataforma 100% online</b>.<br><br>' +
                'Puedes crear tu p√°gina web desde cualquier lugar.<br>¬øNecesitas atenci√≥n presencial? <b>Cont√°ctanos para agendar una cita</b>.';
        }

        // Saludos y presentaci√≥n
        if (/\b(hola|buenas|hey|saludos)\b/.test(lowerMessage)) {
            return 'üëã <b>¬°Hola!</b> Soy el asistente virtual de <b>Tempath</b>.<br><br>' +
                '¬øQu√© te gustar√≠a hacer?<br>' +
                '<ul style="margin: 8px 0 8px 18px; padding: 0; list-style: none;">' +
                '<li>‚Ä¢ Descubrir c√≥mo crear tu p√°gina web</li>' +
                '<li>‚Ä¢ Conocer nuestros <b>servicios</b> o <b>planes</b></li>' +
                '<li>‚Ä¢ Solicitar <b>soporte</b></li>' +
                '</ul>' +
                '¬°Preg√∫ntame lo que quieras!';
        }

        // Qui√©n eres
        if (lowerMessage.includes('qui√©n eres') || lowerMessage.includes('quien eres') || lowerMessage.includes('eres un bot') || lowerMessage.includes('eres real')) {
            return 'ü§ñ <b>Soy el asistente virtual de Tempath</b>.<br>' +
                'Estoy aqu√≠ para ayudarte a:<br>' +
                '<ul style="margin: 8px 0 8px 18px; padding: 0; list-style: none;">' +
                '<li>‚Ä¢ Crear, personalizar y publicar tu p√°gina web</li>' +
                '<li>‚Ä¢ Resolver tus dudas</li>' +
                '<li>‚Ä¢ Guiarte en todo el proceso</li>' +
                '</ul>' +
                '<b>¬°Preg√∫ntame lo que necesites!</b>';
        }

        // Qu√© es Tempath
        if (lowerMessage.includes('qu√© es tempath') || lowerMessage.includes('que es tempath')) {
            return '<b>Tempath</b> es una plataforma que te ayuda a:<br>' +
                '<ul style="margin: 8px 0 8px 18px; padding: 0; list-style: none;">' +
                '<li>‚Ä¢ <b>Crear</b> tu propia p√°gina web</li>' +
                '<li>‚Ä¢ <b>Personalizar</b> textos, im√°genes y colores</li>' +
                '<li>‚Ä¢ <b>Publicar</b> tu web de manera sencilla y r√°pida</li>' +
                '</ul>' +
                'Todo <b>sin necesidad de conocimientos t√©cnicos</b>.';
        }

        // Servicios
        if (lowerMessage.includes('servicio') || lowerMessage.includes('servicios') || lowerMessage.includes('qu√© ofrecen') || lowerMessage.includes('que ofrecen')) {
            return 'üõ†Ô∏è <b>En Tempath ofrecemos:</b><br>' +
                '<ul style="margin: 8px 0 8px 18px; padding: 0;">' +
                '<li>‚Ä¢ Creaci√≥n de p√°ginas web tipo <b>landing</b></li>' +
                '<li>‚Ä¢ P√°ginas especializadas para sectores como belleza, restaurantes, hoteler√≠a, salud, educaci√≥n, consultor√≠as y m√°s</li>' +
                '</ul>' +
                'Todo funciona por <b>planes</b> que se adaptan a tus necesidades.<br><br>' +
                '¬øTe gustar√≠a saber m√°s sobre los planes disponibles?';
        }

        // Si el usuario responde afirmativamente sobre planes tras preguntar por servicios
        if (/\b(s√≠|si|claro|quiero saber|dime|cu√°les|cuales|cu√°l|cual|mu√©strame|muestrame|ver planes|m√°s info|mas info|detalles)\b/.test(lowerMessage) && this.messages.length > 0) {
            // Buscar si la √∫ltima respuesta fue sobre servicios o pregunta de planes
            const lastBotMsg = this.messages.slice().reverse().find(m => m.sender === 'bot');
            if (lastBotMsg && (lastBotMsg.content.includes('¬øTe gustar√≠a saber m√°s sobre los planes disponibles?') || lastBotMsg.content.includes('¬øTe gustar√≠a ver una comparaci√≥n detallada'))) {
                return '<b>Tempath ofrece tres planes:</b><br>' +
                    '<ul style="margin: 8px 0 8px 18px; padding: 0;">' +
                    '<li>üÜì <b>Gratis</b>: Publica tu web con anuncios y subdominio Tempath.</li>' +
                    '<li>üíé <b>Pro</b>: Sin anuncios, subdominio Tempath, ideal para proyectos personales.</li>' +
                    '<li>üåü <b>Personalizado</b>: Sin anuncios, dominio propio, soporte premium y personalizaci√≥n avanzada.</li>' +
                    '</ul>' +
                    '<i>¬øTe gustar√≠a ver una comparaci√≥n detallada o saber cu√°l te conviene seg√∫n tus necesidades?</i>';
            }
        }

        // Gu√≠a paso a paso para crear una p√°gina (patrones ampliados)
        if (
            /como (hago|puedo hacer|puedo crear|hago mi|hago una|hago una web|hago mi pagina|hago mi p√°gina|hago una p√°gina|hago una pagina|lo hago|crear mi p√°gina|crear mi pagina|crear p√°gina|crear pagina|crear una p√°gina|crear una pagina|hacer mi p√°gina|hacer mi pagina|hacer una p√°gina|hacer una pagina|empezar|iniciar)/.test(lowerMessage) ||
            lowerMessage.includes('c√≥mo lo hago') || lowerMessage.includes('como lo hago') || lowerMessage.includes('c√≥mo hago mi p√°gina') || lowerMessage.includes('quiero el paso a paso') || lowerMessage.includes('dame el paso a paso') ||
            lowerMessage.includes('como hago mi pagina') || lowerMessage.includes('quiero hacer mi p√°gina') || lowerMessage.includes('quiero hacer mi pagina') ||
            lowerMessage.includes('quiero crear mi p√°gina') || lowerMessage.includes('s√≠, expl√≠came paso a paso') || lowerMessage.includes('explicame el proceso') || lowerMessage.includes('explicame como hacerlo')
        ) {
            return '<b>¬°Te explico c√≥mo crear tu p√°gina web en Tempath!</b><br>' +
                '<ol style="margin: 8px 0 8px 18px; padding: 0;">' +
                '<li>Haz clic en <b>"Crear mi p√°gina"</b> o reg√≠strate/inicia sesi√≥n.</li>' +
                '<li>Elige una <b>plantilla profesional</b> que te guste.</li>' +
                '<li>Personaliza <b>textos, im√°genes y colores</b> a tu gusto.</li>' +
                '<li>Haz clic en <b>"Publicar"</b> para poner tu web en l√≠nea.</li>' +
                '</ol>' +
                '<i>¬øQuieres que te ayude con alguno de estos pasos o tienes una duda espec√≠fica?</i>';
        }

        // Informaci√≥n sobre planes
        if (lowerMessage.includes('planes') || lowerMessage.includes('precio') || lowerMessage.includes('costo') || lowerMessage.includes('gratuito') || lowerMessage.includes('gratis')) {
            return '<b>Tempath ofrece tres planes:</b><br>' +
                '<ul style="margin: 8px 0 8px 18px; padding: 0;">' +
                '<li>üÜì <b>Gratis</b>: Publica tu web con anuncios y subdominio Tempath.</li>' +
                '<li>üíé <b>Pro</b>: Sin anuncios, subdominio Tempath, ideal para proyectos personales.</li>' +
                '<li>üåü <b>Personalizado</b>: Sin anuncios, dominio propio, soporte premium y personalizaci√≥n avanzada.</li>' +
                '</ul>' +
                '<i>¬øTe gustar√≠a ver una comparaci√≥n detallada o saber cu√°l te conviene seg√∫n tus necesidades?</i>';
        }
        // Migraci√≥n de web
        if (lowerMessage.includes('migrar') || lowerMessage.includes('importar')) {
            return 'üîÑ <b>¬°S√≠! Puedes migrar tu sitio web a Tempath.</b><br>Cont√°ctanos y te ayudaremos a importar tu contenido y configurarlo en nuestra plataforma.';
        }

        // Cambiar plantilla
        if (lowerMessage.includes('cambiar plantilla') || lowerMessage.includes('otra plantilla')) {
            return 'üé® <b>Puedes cambiar de plantilla en cualquier momento</b> desde tu panel de usuario.<br>' +
                'Solo ve a la secci√≥n de <b>dise√±o</b> y elige la nueva plantilla que prefieras.';
        }

        // Tienda en l√≠nea
        if (lowerMessage.includes('tienda en l√≠nea') || lowerMessage.includes('tienda online') || lowerMessage.includes('ecommerce')) {
            return 'üõí <b>¬°Por supuesto! Tempath permite agregar una tienda en l√≠nea a tu p√°gina.</b><br>' +
                'Puedes gestionar productos, pagos y pedidos f√°cilmente desde tu panel.';
        }

        // M√©todos de pago
        if (lowerMessage.includes('metodos de pago') ||lowerMessage.includes('m√©todos de pago') || lowerMessage.includes('formas de pago') || lowerMessage.includes('aceptan tarjeta')) {
            return 'üí≥ <b>Aceptamos pagos con:</b><br>' +
                '<ul style="margin: 8px 0 8px 18px; padding: 0;">' +
                '<li>‚Ä¢ Tarjeta de cr√©dito</li>' +
                '<li>‚Ä¢ Tarjeta de d√©bito</li>' +
                '<li>‚Ä¢ PayPal</li>' +
                '</ul>' +
                'para los planes de pago.<br>¬øTe gustar√≠a saber c√≥mo actualizar tu plan?';
        }

        // Ejemplos de p√°ginas
        if (lowerMessage.includes('ejemplo de p√°gina') || lowerMessage.includes('ejemplo de web') || lowerMessage.includes('ver ejemplos')) {
            return 'üåê <b>Puedes ver ejemplos de p√°ginas creadas con Tempath</b> en nuestra galer√≠a de inspiraci√≥n.<br>' +
                '¬øQuieres que te env√≠e el enlace?';
        }

        // Recuperar contrase√±a
        if (lowerMessage.includes('olvid√© mi contrase√±a') || lowerMessage.includes('olvide mi contrase√±a') || lowerMessage.includes('recuperar contrase√±a')) {
            return 'üîë <b>¬øOlvidaste tu contrase√±a?</b><br>Haz clic en <b>"¬øOlvidaste tu contrase√±a?"</b> en la pantalla de inicio de sesi√≥n y sigue los pasos para restablecerla.';
        }

        // Eliminar cuenta
        if (lowerMessage.includes('eliminar mi cuenta') || lowerMessage.includes('borrar mi cuenta') || lowerMessage.includes('cancelar mi cuenta')) {
            return '‚ö†Ô∏è <b>Lamentamos que quieras irte.</b><br>Puedes eliminar tu cuenta desde la configuraci√≥n de tu perfil.<br>Si necesitas ayuda, cont√°ctanos y te asistiremos.';
        }

        // Colaborar con otros
        if (lowerMessage.includes('colaborar') || lowerMessage.includes('trabajar en equipo') || lowerMessage.includes('agregar usuario')) {
            return 'ü§ù <b>Puedes invitar a otros usuarios a colaborar en tu p√°gina</b> desde la secci√≥n de <b>equipo</b> en tu panel de usuario.';
        }

        // Renovaci√≥n y actualizaci√≥n de plan
        if (lowerMessage.includes('no renuevo') || lowerMessage.includes('no pago') || lowerMessage.includes('actualizar plan') || lowerMessage.includes('cambiar plan')) {
            return 'üîÑ <b>Si no renuevas tu plan</b>, tu p√°gina pasar√° al <b>plan gratuito con anuncios</b>.<br>Puedes actualizar o cambiar de plan en cualquier momento desde tu panel.';
        }

        // App m√≥vil
        if (lowerMessage.includes('app m√≥vil') || lowerMessage.includes('app android') || lowerMessage.includes('app ios')) {
            return 'üì± <b>Actualmente Tempath funciona desde cualquier navegador m√≥vil.</b><br>' +
                'Pronto lanzaremos nuestra app para Android y iOS.';
        }

        // Blog
        if (lowerMessage.includes('agregar blog') || lowerMessage.includes('tengo blog') || lowerMessage.includes('blog en mi web')) {
            return 'üìù <b>Puedes agregar un blog a tu p√°gina</b> desde la secci√≥n de m√≥dulos.<br>' +
                'Es f√°cil de usar y personalizar.';
        }

        // Google Analytics
        if (lowerMessage.includes('google analytics') || lowerMessage.includes('estad√≠sticas') || lowerMessage.includes('visitas web')) {
            return 'üìä <b>Puedes integrar Google Analytics</b> y ver estad√≠sticas de tu web desde tu panel de usuario.';
        }

        // C√≥digo propio
        if (lowerMessage.includes('c√≥digo propio') || lowerMessage.includes('agregar c√≥digo') || lowerMessage.includes('html personalizado')) {
            return 'üíª <b>En el plan Personalizado puedes agregar tu propio c√≥digo HTML, CSS o JS</b> para personalizar a√∫n m√°s tu web.';
        }

        // Seguridad
        if (lowerMessage.includes('seguridad') || lowerMessage.includes('es seguro') || lowerMessage.includes('protecci√≥n')) {
            return 'üîí <b>Tempath utiliza cifrado SSL</b> y buenas pr√°cticas de seguridad para proteger tu informaci√≥n y la de tus visitantes.';
        }

        // Contacto humano y soporte directo (tambi√©n para "contacto" y similares)
        if (
            lowerMessage.includes('humano') ||
            lowerMessage.includes('soporte humano') ||
            lowerMessage.includes('hablar con alguien') ||
            lowerMessage.includes('atenci√≥n humana') ||
            lowerMessage.includes('quiero hablar con soporte') ||
            lowerMessage.includes('quiero hablar con un humano') ||
            lowerMessage.includes('quiero soporte real') ||
            lowerMessage.includes('quiero soporte directo') ||
            lowerMessage.includes('quiero contactar a soporte') ||
            lowerMessage.includes('quiero contactar soporte') ||
            lowerMessage.includes('quiero contactar a un humano') ||
            lowerMessage.includes('quiero contactar a alguien') ||
            lowerMessage.includes('quiero atenci√≥n personalizada') ||
            lowerMessage.includes('quiero atenci√≥n humana') ||
            lowerMessage.includes('quiero ayuda de un humano') ||
            lowerMessage.includes('quiero ayuda real') ||
            lowerMessage.includes('quiero ayuda directa') ||
            lowerMessage.includes('quiero ayuda personalizada') ||
            lowerMessage.includes('quiero ayuda de soporte') ||
            lowerMessage.includes('quiero ayuda de alguien') ||
            lowerMessage.includes('quiero ayuda con un agente') ||
            lowerMessage.includes('quiero hablar con un agente') ||
            lowerMessage.includes('quiero contactar a un agente') ||
            lowerMessage.includes('quiero contactar agente') ||
            lowerMessage.includes('quiero contactar a soporte humano') ||
            lowerMessage.includes('quiero contactar a soporte real') ||
            lowerMessage.includes('quiero contactar a soporte directo') ||
            lowerMessage.includes('contacto') ||
            lowerMessage.includes('contactar') ||
            lowerMessage.includes('correo') ||
            lowerMessage.includes('email')
        ) {
            return 'üë®‚Äçüíª <b>Si necesitas atenci√≥n personalizada, aqu√≠ tienes opciones:</b><br>' +
                '<ul style="margin: 8px 0 8px 18px; padding: 0;">' +
                '<li>1Ô∏è‚É£ <a href="mailto:soporte@tempath.com" target="_blank"><b>Escribir correo</b></a> <span style="color:#888;">(abrir√° Gmail u otro gestor de correo)</span></li>' +
                '<li>2Ô∏è‚É£ <a href="#contact" onclick="document.getElementById(\'chatbotClose\').click();" style="color:#007bff;"><b>Usar formulario</b></a> <span style="color:#888;">(te lleva al apartado Cont√°ctanos)</span></li>' +
                '<li>3Ô∏è‚É£ <a href="https://web.whatsapp.com/" target="_blank"><b>WhatsApp</b></a> <span style="color:#888;">(pr√≥ximamente soporte directo por WhatsApp)</span></li>' +
                '</ul>';
        }

        // Soporte t√©cnico (no humano)
        if (lowerMessage.includes('soporte') || lowerMessage.includes('ayuda') || lowerMessage.includes('problema') || lowerMessage.includes('error')) {
            return 'üõ†Ô∏è <b>Estoy aqu√≠ para ayudarte.</b><br>' +
                'Por favor, describe tu problema o duda y te oriento paso a paso.<br>' +
                'Si es algo t√©cnico, dime en qu√© parte del proceso tienes el inconveniente y te ayudo a resolverlo.<br><br>' +
                '<b>¬øQuieres que te pase con un t√©cnico especializado de Tempath para atenci√≥n personalizada?</b>';
        }

        // Si el usuario responde afirmativamente tras pregunta de soporte t√©cnico
        if (/\b(s√≠|si|claro|quiero|deseo|por favor|ayuda|hablar|contactar|tecnico|t√©cnico|especialista|humano)\b/.test(lowerMessage) && this.messages.length > 0) {
            const lastBotMsg = this.messages.slice().reverse().find(m => m.sender === 'bot');
            if (lastBotMsg && lastBotMsg.content.includes('¬øQuieres que te pase con un t√©cnico especializado')) {
                return 'üë®‚Äçüíª <b>Si necesitas atenci√≥n personalizada, aqu√≠ tienes opciones:</b><br>' +
                    '<ul style="margin: 8px 0 8px 18px; padding: 0;">' +
                    '<li>1Ô∏è‚É£ <a href="mailto:soporte@tempath.com" target="_blank"><b>Escribir correo</b></a> <span style="color:#888;">(abrir√° Gmail u otro gestor de correo)</span></li>' +
                    '<li>2Ô∏è‚É£ <a href="#contact" onclick="document.getElementById(\'chatbotClose\').click();" style="color:#007bff;"><b>Usar formulario</b></a> <span style="color:#888;">(te lleva al apartado Cont√°ctanos)</span></li>' +
                    '<li>3Ô∏è‚É£ <a href="https://web.whatsapp.com/" target="_blank"><b>WhatsApp</b></a> <span style="color:#888;">(pr√≥ximamente soporte directo por WhatsApp)</span></li>' +
                    '</ul>';
            }
        }

        // Preguntas frecuentes
        if (lowerMessage.includes('dominio')) {
            return 'üåê <b>En el plan Personalizado puedes usar tu propio dominio.</b><br>' +
                'En los otros planes, tu web estar√° bajo un subdominio de Tempath.';
        }
        if (lowerMessage.includes('anuncios')) {
            return 'üì¢ <b>El plan gratuito incluye anuncios.</b><br>' +
                'Si prefieres una web sin anuncios, elige el plan Pro o Personalizado.';
        }
        if (lowerMessage.includes('plantilla') || lowerMessage.includes('dise√±o')) {
            return 'üé® <b>Puedes elegir entre varias plantillas profesionales</b> y personalizarlas a tu gusto desde el editor.<br>' +
                '¬øQuieres ver ejemplos de plantillas?';
        }
        if (lowerMessage.includes('publicar')) {
            return 'üöÄ <b>Cuando termines de personalizar tu p√°gina</b>, haz clic en <b>"Publicar"</b> y tu web estar√° en l√≠nea al instante.';
        }
        if (lowerMessage.includes('editar')) {
            return '‚úèÔ∏è <b>Puedes editar tu p√°gina en cualquier momento</b> desde tu panel de usuario.<br>' +
                'Los cambios se reflejan al instante.';
        }

        // Despedidas
        if (/\b(gracias|adi√≥s|adios|chao|bye)\b/.test(lowerMessage)) {
            setTimeout(() => { this.setStatus('dormido'); }, 500);
            return 'üôå <b>¬°Gracias por usar Tempath!</b><br>' +
                'Si tienes m√°s preguntas, aqu√≠ estar√© para ayudarte.<br>' +
                '¬°√âxito con tu p√°gina web!';
        }

        // Sugerencias de acci√≥n
        if (lowerMessage.includes('empezar') || lowerMessage.includes('iniciar')) {
            return '‚ú® <b>¬°Perfecto!</b><br>' +
                'Haz clic en <b>"Crear mi p√°gina"</b> en la parte superior<br>o dime si quieres que te gu√≠e paso a paso.';
        }

        // Respuesta por defecto
        const defaultResponses = [
            'ü§î <b>¬øQuieres que te explique paso a paso c√≥mo crear tu p√°gina web en Tempath?</b>',
            'üí° <b>¬øTienes dudas sobre plantillas, personalizaci√≥n, publicaci√≥n o soporte?</b><br>¬°Preg√∫ntame!',
            'üìã <b>¬øTe gustar√≠a saber m√°s sobre los planes, pagos o c√≥mo publicar tu web?</b>',
            'üßë‚Äçüíª <b>Estoy aqu√≠ para ayudarte en todo el proceso de creaci√≥n de tu p√°gina.</b><br>¬øEn qu√© paso necesitas ayuda?',
            'üåü <b>¬øQuieres ver ejemplos de p√°ginas creadas con Tempath, agregar tienda, blog o necesitas soporte t√©cnico?</b>'
        ];
        return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
    }
}

// Inicializar el chatbot cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    new ChatBot();
});